# Wallet Service API

REST API —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞–º–∏ —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å–ø–∏—Å–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤. –°–µ—Ä–≤–∏—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–≥—É—é –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ (1000 RPS –Ω–∞ –æ–¥–∏–Ω –∫–æ—à–µ–ª–µ–∫) –±–µ–∑ –æ—à–∏–±–æ–∫ 50x.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ UUID
- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—à–µ–ª—å–∫–∞ (DEPOSIT)
- –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ —Å –∫–æ—à–µ–ª—å–∫–∞ (WITHDRAW)
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—à–µ–ª—å–∫–∞
- –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## üöÄ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Go 1.24+** - –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **PostgreSQL 16** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Docker & Docker Compose** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **Chi Router v5** - HTTP —Ä–æ—É—Ç–∏–Ω–≥
- **pgx/v5** - PostgreSQL –¥—Ä–∞–π–≤–µ—Ä
- **Squirrel** - SQL query builder
- **Swagger/OpenAPI** - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- **k6** - –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- `github.com/shopspring/decimal` - —Ç–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –¥–µ–Ω–µ–∂–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏
- `github.com/golang-migrate/migrate/v4` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –ë–î
- `go.uber.org/mock` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- `github.com/stretchr/testify` - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏:

```
cmd/wallet/           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
internal/
  api/                # HTTP –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ —Ä–æ—É—Ç–∏–Ω–≥
    handlers/         # HTTP handlers
    middleware/       # Middleware (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–∞–π–º–∞—É—Ç—ã)
  service/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
  repository/         # –†–∞–±–æ—Ç–∞ —Å –ë–î
  config/             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
pkg/
  postgres/           # PostgreSQL connection pool
  sync/               # Keyed mutex –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏
migrations/           # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
tests/
  integration/        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
  k6/                 # –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
```

## üîê –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏

–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ 1000 RPS –Ω–∞ –æ–¥–∏–Ω –∫–æ—à–µ–ª–µ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**:

### 1. Keyed Mutex –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –æ–¥–Ω–æ–º—É –∫–æ—à–µ–ª—å–∫—É —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ —á–µ—Ä–µ–∑ `sync.Map` —Å –º—å—é—Ç–µ–∫—Å–∞–º–∏ –ø–æ –∫–ª—é—á—É `walletID`:
- –ò—Å–∫–ª—é—á–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é –∑–∞ DB connections
- –û–ø–µ—Ä–∞—Ü–∏–∏ –∂–¥—É—Ç –≤ –ø–∞–º—è—Ç–∏, –Ω–µ –∑–∞–Ω–∏–º–∞—è —Ä–µ—Å—É—Ä—Å—ã –ë–î
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤

### 2. PostgreSQL Advisory Locks
```sql
SELECT pg_advisory_xact_lock(hashtext(wallet_id))
```
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

### 3. SERIALIZABLE —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å retry
- –£—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ `SERIALIZABLE` –¥–ª—è —Å—Ç—Ä–æ–≥–æ–π –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –ø—Ä–∏ serialization failures
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- Squirrel query builder –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ SQL overhead
- –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `uuidToInt64` –¥–ª—è advisory locks
- –°–Ω–∏–∂–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ production (DEBUG ‚Üí INFO)
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π connection pool (10 idle, 40 max open)
- PostgreSQL: `synchronous_commit=off`, `shared_buffers=512MB`

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Docker 20.10+
- Docker Compose 2.0+
- Go 1.24+ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**
```bash
git clone <repository-url>
cd ITK
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Docker Compose**
```bash
docker-compose up --build -d
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:8080`

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**
```bash
curl http://localhost:8080/health
```

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
```bash
go mod download
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL**
```bash
docker-compose up postgres -d
```

3. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏**
```bash
make migrate-up
```

4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
```bash
make run
```

## üîå API Endpoints

### Swagger UI
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:8080/swagger/index.html`

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### –°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª–µ–∫
```http
POST /api/v1/wallet/create
```

**Response (201):**
```json
{
  "walletId": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
```http
POST /api/v1/wallet
Content-Type: application/json

{
  "walletId": "550e8400-e29b-41d4-a716-446655440000",
  "operationType": "DEPOSIT",
  "amount": 1000.50
}
```

**Response (200):**
```json
{
  "status": "success"
}
```

**–ö–æ–¥—ã –æ—à–∏–±–æ–∫:**
- `400` - –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
- `404` - –ö–æ—à–µ–ª–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω
- `409` - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (–¥–ª—è WITHDRAW)
- `500` - –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

#### –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å
```http
GET /api/v1/wallets/{walletId}
```

**Response (200):**
```json
{
  "walletId": "550e8400-e29b-41d4-a716-446655440000",
  "balance": 5000.50
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã
```bash
make test-unit
```

–ü–æ–∫—Ä—ã—Ç–∏–µ:
- `internal/service/` - —Ç–µ—Å—Ç—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ —Å –º–æ–∫–∞–º–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- `internal/api/handlers/` - —Ç–µ—Å—Ç—ã HTTP handlers —Å –º–æ–∫–∞–º–∏ —Å–µ—Ä–≤–∏—Å–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `testify/suite` –∏ `gomock`

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```bash
make test-integration
```

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ó–∞–ø—É—â–µ–Ω–Ω–∞—è PostgreSQL –Ω–∞ `localhost:5433`
- –ó–∞–ø—É—â–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ `http://localhost:8080`

–ò–ª–∏ —á–µ—Ä–µ–∑ Docker:
```bash
docker-compose up -d
INTEGRATION_TESTS=true make test-integration
```

### –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã (k6)

#### 1. Constant Load Test (1000 VUs –Ω–∞ –æ–¥–∏–Ω –∫–æ—à–µ–ª–µ–∫)
```bash
make k6-constant
```
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

#### 2. Spike Test (—Ä–µ–∑–∫–∏–π —Å–∫–∞—á–æ–∫ –¥–æ 2000 VUs)
```bash
make k6-spike
```
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –ø—Ä–∏ —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–∞—Ö –Ω–∞–≥—Ä—É–∑–∫–∏

#### 3. Stress Test (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏)
```bash
make k6-stress
```
**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ —Ç–æ—á–∫—É –æ—Ç–∫–∞–∑–∞ —Å–∏—Å—Ç–µ–º—ã

#### 4. Soak Test (–¥–ª–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç 30 –º–∏–Ω—É—Ç)
```bash
make k6-soak
```
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

#### 5. Multi-Wallet Test (100 VUs –Ω–∞ 10 –∫–æ—à–µ–ª—å–∫–æ–≤)
```bash
make k6-multi
```
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–æ—à–µ–ª—å–∫–∞–º–∏

#### –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ k6 —Ç–µ—Å—Ç—ã (–∫—Ä–æ–º–µ soak)
```bash
make k6-all
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### Constant Load Test (1000 VUs, 1 –∫–æ—à–µ–ª–µ–∫)
- ‚úÖ **0% –æ—à–∏–±–æ–∫ 50x** (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¢–ó –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
- ‚úÖ **100% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** (47,325 –∏—Ç–µ—Ä–∞—Ü–∏–π)
- ‚úÖ **~769 RPS** —Ä–µ–∞–ª—å–Ω—ã–π throughput
- ‚ö†Ô∏è **Latency p95: 1.8s** (–≤—ã—Å–æ–∫–∞—è –∏–∑-–∑–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
- ‚úÖ **–ë–∞–ª–∞–Ω—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω** - –ø–æ–ª–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

#### Multi-Wallet Test (100 VUs, 10 –∫–æ—à–µ–ª—å–∫–æ–≤)
- ‚úÖ **100% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** (150,337 –∏—Ç–µ—Ä–∞—Ü–∏–π)
- ‚úÖ **Latency p95: 107ms** (–æ—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- ‚úÖ **~1,251 RPS** –æ–±—â–∏–π throughput

**–í—ã–≤–æ–¥:** –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¢–ó "–ù–∏ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω (50–• error)" –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ 1000 RPS –Ω–∞ –æ–¥–∏–Ω –∫–æ—à–µ–ª–µ–∫.

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–∞–π–ª `config/local.env`:

```env
ENV=local
HTTP_ADDRESS=0.0.0.0:8080
HTTP_TIMEOUT=120s
HTTP_IDLE_TIMEOUT=180s

DB_HOST=postgres
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=wallet
DB_MAX_IDLE_CONNS=10
DB_MAX_OPEN_CONNS=40
DB_CONN_MAX_LIFETIME=3600

RETRY_MAX_ATTEMPTS=10
RETRY_BASE_DELAY_MS=10
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|----------|--------------|
| `ENV` | –û–∫—Ä—É–∂–µ–Ω–∏–µ (local/production) | `local` |
| `HTTP_ADDRESS` | –ê–¥—Ä–µ—Å HTTP —Å–µ—Ä–≤–µ—Ä–∞ | `0.0.0.0:8080` |
| `HTTP_TIMEOUT` | –¢–∞–π–º–∞—É—Ç HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ | `120s` |
| `DB_MAX_OPEN_CONNS` | –ú–∞–∫—Å. —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î | `40` |
| `RETRY_MAX_ATTEMPTS` | –ü–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ serialization failure | `10` |
| `RETRY_BASE_DELAY_MS` | –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ retry (–º—Å) | `10` |

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞

```sql
-- –ö–æ—à–µ–ª—å–∫–∏
CREATE TABLE wallets (
    id UUID PRIMARY KEY,
    balance NUMERIC(20, 2) NOT NULL DEFAULT 0 CHECK (balance >= 0),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- –û–ø–µ—Ä–∞—Ü–∏–∏ (audit log)
CREATE TABLE operations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    wallet_id UUID NOT NULL REFERENCES wallets(id) ON DELETE CASCADE,
    operation_type VARCHAR(20) NOT NULL CHECK (operation_type IN ('DEPOSIT', 'WITHDRAW')),
    amount NUMERIC(20, 2) NOT NULL CHECK (amount > 0),
    balance_after NUMERIC(20, 2) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

### –ò–Ω–¥–µ–∫—Å—ã
- `idx_wallets_created_at` - –ø–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
- `idx_wallets_balance` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –±–∞–ª–∞–Ω—Å—É
- `idx_operations_wallet_id` - –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ—à–µ–ª—å–∫—É
- `idx_operations_created_at` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π

### –ú–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
make migrate-up
```

–û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
make migrate-down
```

## üõ†Ô∏è Makefile –∫–æ–º–∞–Ω–¥—ã

```bash
make build          # –°–æ–±—Ä–∞—Ç—å –±–∏–Ω–∞—Ä–Ω–∏–∫–∏
make run            # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
make test-unit      # Unit —Ç–µ—Å—Ç—ã
make test-integration # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
make test-all       # –í—Å–µ —Ç–µ—Å—Ç—ã
make swagger        # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
make gen-mocks      # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–∫–∏
make migrate-up     # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
make migrate-down   # –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
make docker-build   # –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
make docker-up      # –ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Docker Compose
make docker-down    # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
make k6-constant    # k6: Constant load test
make k6-spike       # k6: Spike test
make k6-stress      # k6: Stress test
make k6-soak        # k6: Soak test (30 –º–∏–Ω—É—Ç)
make k6-multi       # k6: Multi-wallet test
make k6-all         # k6: –í—Å–µ —Ç–µ—Å—Ç—ã –∫—Ä–æ–º–µ soak
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (`log/slog`):

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **Local/Development:** `DEBUG` (—Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
- **Production:** `INFO` (JSON —Ñ–æ—Ä–º–∞—Ç)

### –õ–æ–≥–∏—Ä—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
- HTTP –∑–∞–ø—Ä–æ—Å—ã: method, path, status, duration, request_id
- –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ—à–µ–ª—å–∫–∞–º–∏: wallet_id, operation_type, amount, balance
- –û—à–∏–±–∫–∏: error, context, stack trace

### Middleware –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–ö–∞–∂–¥—ã–π HTTP –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏:
```json
{
  "component": "middleware/logger",
  "method": "POST",
  "path": "/api/v1/wallet",
  "status": 200,
  "bytes": 25,
  "duration": "125.5ms",
  "request_id": "abc123..."
}
```

## üê≥ Docker

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ docker-compose.yml

```yaml
services:
  postgres:
    image: postgres:16
    # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
    
  app:
    build: .
    depends_on:
      postgres:
        condition: service_healthy
```

### Docker entrypoint

`docker-entrypoint.sh` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
1. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL
2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
3. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í–∞–ª–∏–¥–∞—Ü–∏—è UUID –Ω–∞ —É—Ä–æ–≤–Ω–µ handler
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å—É–º–º –æ–ø–µ—Ä–∞—Ü–∏–π
- CHECK constraints –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (`balance >= 0`, `amount > 0`)
- FOREIGN KEY constraints –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- Graceful shutdown —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
1. **Connection pooling** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DB —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
2. **Prepared statements** - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤  
3. **Advisory locks** - –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Å—Ç—Ä–æ–∫
4. **Keyed mutex** - —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏
5. **Squirrel builder** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
6. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL** - `shared_buffers`, `work_mem`, WAL

### –ú–µ—Ç—Ä–∏–∫–∏ (1000 RPS –Ω–∞ –æ–¥–∏–Ω –∫–æ—à–µ–ª–µ–∫)
- **Throughput:** ~769 operations/sec
- **Latency p50:** ~1.2s
- **Latency p95:** ~1.8s
- **Success rate:** 100%
- **Error rate:** 0%

## üöß –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **Latency –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏:** –ü—Ä–∏ 1000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–¥–∏–Ω –∫–æ—à–µ–ª–µ–∫ latency –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç –∏–∑-–∑–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π (trade-off –∑–∞ —Å—Ç—Ä–æ–≥—É—é –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

2. **–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:** –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (–±–æ–ª–µ–µ –º–æ—â–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)

3. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í–æ–∑–º–æ–∂–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç:
   - Sticky sessions –ø–æ `walletID` –Ω–∞ load balancer
   - –ò–ª–∏ distributed locks (Redis, etcd)
   - –ò–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

## üîÑ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **Event Sourcing** - –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –µ—â–µ –±–æ–ª—å—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. **CQRS** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ read/write –º–æ–¥–µ–ª–µ–π
3. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤** - Redis –¥–ª—è read-heavy –Ω–∞–≥—Ä—É–∑–∫–∏
4. **Distributed tracing** - OpenTelemetry/Jaeger
5. **–ú–µ—Ç—Ä–∏–∫–∏** - Prometheus + Grafana
6. **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç DDOS
7. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - `operation_id` –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## üë• –ê–≤—Ç–æ—Ä

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è

## ü§ù –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ Issue –≤ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
